-
  include: tests/templates/kv.yml, tests/templates/n1ql.yml, tests/templates/rebalance.yml

############### data loading ################
-
  image: sequoiatools/gideon
  command: "kv --ops {{.Scale 1000}} --create 30 --get 70 --delete 10     --hosts {{.Orchestrator}} --bucket {{.Bucket}}"
-
  command: "kv --ops {{.Scale 500}} --create 60 --get 40 --sizes 64 96   --hosts {{.Orchestrator}} --bucket {{.NthBucket 1}}"
-
  command: "kv --ops {{.Scale 500}} --create 60 --get 40 --sizes 64 96   --hosts {{.Orchestrator}} --bucket {{.NthBucket 2}}"
-
  command: "kv --ops {{.Scale 200}} --create 100 --sizes 1024  --hosts {{.Orchestrator}} --bucket {{.NthBucket 3}}"


###############  create indexes ################
- section_start: create_replica_indexes

-
   image: sequoiatools/cbq
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='create index default_rating on `default`(rating) using GSI with {\"num_replica\":1}'"
-
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='create index default_claims on `default`(claim) using GSI with {\"num_replica\":2}'"
-
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='create index default_result on `default`(result) using GSI with {\"num_replica\":1, \"defer_build\": true}'"
-
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='create primary index on `default` using GSI with {\"num_replica\":2}'"
-
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='create index o1_rating on `other-1`(rating) using GSI with {\"num_replica\":2}'"
-
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='create index o1_claims on `other-1`(claim) using GSI with {\"num_replica\":1, \"defer_build\": true}'"
-
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='create index o1_result on `other-1`(result) using GSI with {\"num_replica\":1}'"
-
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='create index o2_rating on `other-2`(rating) using GSI with {\"num_replica\":2}'"
-
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='create index o2_claims on `other-2`(claim) using GSI with {\"num_replica\":1}'"
-
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='create index o2_result on `other-2`(result) using GSI with {\"num_replica\":2}'"
-
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='create index o3_rating on `other-3`(rating) using GSI with {\"num_replica\":1, \"defer_build\": true}'"
-
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='create index o3_claims on `other-3`(claim) using GSI with {\"num_replica\":1}'"
-
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='create index o3_result on `other-3`(result) using GSI with {\"num_replica\":2}'"
-
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='build index on `default`(result)"
-
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='build index on `other-3`(rating)"
-
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='build index on `other-3`(rating)"
   wait: true

- section_end: create_replica_indexes

# ###############  run queries ################
- section_start: query_replica_indexes
- template: attack_query
- args: "{{.QueryNodePort}}, 0, {{.Scale 10}},'select SUM\\(result) from default where result > 0 limit 50'"
- args: "{{.QueryNodePort}}, 0, {{.Scale 10}},'select claim from default where result > 0 limit 50'"
- args: "{{.QueryNodePort}}, 0, {{.Scale 10}},'select SUM\\(result) from `other-1` where result > 100  limit 50'"
- args: "{{.QueryNodePort}}, 0, {{.Scale 10}},'select * from `other-1` where result > 100  limit 50'"
- args: "{{.QueryNodePort}}, 0, {{.Scale 10}},'select SUM\\(result) from `other-2` where claim like c% limit 50'"
- args: "{{.QueryNodePort}}, 0, {{.Scale 10}},'select SUM\\(result) from `other-3` where rating like a% limit 20'"
- section_end: query_replica_indexes


############### run creates ################
-
  image: sequoiatools/gideon
  command: "kv --ops {{.Scale 1000}} --create 30 --get 70 --delete 10    --hosts {{.Orchestrator}} --bucket {{.Bucket}}"
  duration: 1200
-
  command: "kv --ops {{.Scale 1000}} --create 50 --get 50 --delete 10  --sizes 64 96   --hosts {{.Orchestrator}} --bucket {{.NthBucket 1}}"
  duration: 1200
-
  command: "kv --ops {{.Scale 1000}} --create 80 --get 20 --delete 40  --sizes 64 96   --hosts {{.Orchestrator}} --bucket {{.NthBucket 2}}"
  duration: 1200
-
  command: "kv --ops {{.Scale 1000}} --create 30 --get 70 --delete 10  --sizes 512  --hosts {{.Orchestrator}} --bucket {{.NthBucket 3}}"
  duration: 1200

- section_start: change_indexer_topologies

###############  Rebalance-in single node ################
- template: rebalance_in
  args: "{{.InActiveNode}}, index"
  wait: true

###############  Rebalance-out single node ################
-
  template: rebalance_out
  args: "{{IndexNode}}"
  wait: true

###############  Swap single index node ################
- template: rebalance_swap
  args: "{{.InActiveNode}}, {{.IndexNode}}, index"
  wait: true

###############  Rebalance-in two nodes ################
- template: add_node
  args: "{{.InActiveNode}}, index"
- args: "{{.InActiveNode}}, index"
- template: rebalance
  wait: true

###############  Rebalance-out two nodes ################
- template: rebalance_out
  args: "({{.NthIndexNode 0}},{{.NthIndexNode 1}})"
  wait: true

###############  Swap Rebalance two nodes ################
- template: add_node
  args: "{{.InActiveNode}}, index"
- args: "{{.InActiveNode}}, index"
- template: rebalance_out
  args: "({{.NthIndexNode 2}},{{.NthIndexNode 3}})"
  wait: true


###############  Failover and addback ################
- template: failover_node_forced
  args: "{{.NthIndexNode 2}}"
- template: readd_node
  args: "{{.NthIndexNode 2}}"
- template: recover_node
  args: "{{.NthIndexNode 2}}, full"
- template: rebalance
  wait: true

###############  Failover and rebalance out ################
- template: failover_node_forced
  args: "{{.NthIndexNode 3}}"
- template: rebalance
  wait: true

###############  Rebalance-out single node ################
- template: rebalance_out
  args: "{{.NthIndexNode 2}}"
  wait: true

- section_end: change_indexer_topologies

###############  Drop some Indexes ################
- section_start: recreate_replica_indexes
-
   image: sequoiatools/cbq
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='drop index `default`'"
-
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='drop index `default`.default_rating'"
-
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='drop index `other-1`.o1_rating'"
-
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='drop index `other-1`.o1_claims'"
-
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='drop index `other-2`.o2_results'"
-
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='drop index `other-3`.o3_rating'"
-
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='drop index `other-3`.o3_results'"
   wait: true

###############  Recreate some Indexes ################
-
   image: sequoiatools/cbq
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='create index default_claims on `default`(claim) using GSI'"
-
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='create primary index on `default` using GSI'"

   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='create index o1_result on `other-1`(result) using GSI'"
-
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='create index o2_claims on `other-2`(claim) using GSI'"
-
   command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='create index o3_claims on `other-3`(claim) using GSI'"
   wait: true

- section_end: recreate_replica_indexes

###############  Rebalance-out last index node ################
-
   image: sequoiatools/couchbase-cli
   command:  "rebalance -c  {{.Orchestrator}}:{{.RestPort}} --server-remove {{.Nodes | net 3}}:{{.RestPort}} -u  {{.RestUsername}} -p  {{.RestPassword}}"
   wait: true
